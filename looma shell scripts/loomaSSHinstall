#!/bin/bash
#
# "loomaSSHinstall" script to be run on a Looma box to use reverse SSH server
#     based on the autogenerated install script from "reversessh -a <clientname>" by Termilus
#
if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root."
  exit 1
fi

pause () {
   read -p "Paused, press [Enter] to continue"
}  #  end pause()

user=odroid

echo "Enter the Looma name for remotely accessing to this Looma:"
echo "Note: hostnames are usually 'Lxxx' or 'Nxxx'. hostname must be unique among all Loomas"
echo "the name must be 7 characters or less"
read loomaname
echo
echo "(Optional) Enter the school name [or Return]:"
read schoolname

touch ~/.ssh
chmod 700 ~/.ssh
touch ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
touch ~/.ssh/known_hosts
chmod 600 ~/.ssh/known_hosts
#
# this is the private key for all field Loomas to access the ReverseSSH server
# it gets added to /home/$user/.ssh/looma-remote_rsa on the Looma
echo -e "# private key used by remote Loomas \n
-----BEGIN RSA PRIVATE KEY-----
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
HU/D03U/a3J Ym992Bb65hMMgghQd8DyQINV43qC4Vdw5SHUJ9VbhfoQZ41MH
-----END RSA PRIVATE KEY-----" > /home/$user/.ssh/looma-remote_rsa

#
# this is the publicv key for all field Loomas to access the ReverseSSH server
# it gets added to /home/$user/.ssh/looma-remote_rsa.pub on the Looma
ssh-keygen -y -f /home/$user/.ssh/looma-remote_rsa > /home/$user/.ssh/looma-remote_rsa.pub

chmod 600 "/home/$user/.ssh/looma-remote_rsa"
chmod 644 "/home/$user/.ssh/looma-remote_rsa.pub"

echo "private key for this Looma has been stored in /home/$user/.ssh/looma-remote_rsa"
echo "public key for this Looma has been stored in /home/$user/.ssh/looma-remote_rsa.pub"
echo "     [to be used to authenticate this Looma when the reverseSSH server tries to ssh in]"
echo

pause

#
# this is the public key of the ReverseSSH server
#    add it to /home/$user/.ssh/authorized_keys and known_hosts
#    it came from /home/ec2-user/.ssh/looma-skip-id_rsa.pub on the reverse SSH server

touch /home/$user/.ssh/authorized_keys
touch /home/$user/.ssh/known_hosts
chmod 600 /home/$user/.ssh/authorized_keys
chmod 600 /home/$user/.ssh/known_hosts

serverpublickey="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDeeTCDBtGIhbXVK7CR9dG/2TfkTNqVR6wlxkn18wcUA+swz+cIvpDWTBkYU4ykHRt7Tacq/I4eGxewKdk4AMhc85hHa7kobX7F+QYyIhQ0YkVHGqYcdaxBJ4xOMjY98PI3cALb6GEr/fWJNPP6JSzFuHPuCG/0oAQV9H9KgyWFgbVoMNVGjamenNLbenND9+U723b9vBeQdKy8LYxnM9hyzWVLCMdZ63PwUY4V35Vqo1dHMfDjRlyCUnAAnD62GW++Mg7vLAxhvAsqoDZSz76k+bD8FkNx4xl+czrr9bipdilkNBeP1rJi7a5tHd2Wrbl1+sOvl0W/oMvjPGC9x2ifRWhH+AVEVFSTNEyxFIj+hbBI/b9DmjN5pCrsslTr/tJMJyqRck6V11mTO2U1rE2qACd9blnJ6Nfk3h1KK3NKG1h/K5JFq1ds+D8kx+SXdbrLQ9TzYZVNboyBEiJ2XXzxRbizhj8hUmnzt1Vrb6roVswmdXQlZuILa65Nu6CZRv/dEDDo9ioDEvQH/BkMc/ixTEeGr+O2hbpukKdok/U3Hm4Y/cj+jrzLvwtdAfs60HPQX3Fp44up0TPeeHrCHNN/z7dpccKtu6NsIWQqoG1bTzwTuBF2rNZyolEF0UM6xwmMBIvnfVO2Vy5oDbYCb+cyQHp/6xXLlAwY6neCYhWFNQ== looma@ip-172-31-17-231.us-west-2.compute.internal"
echo $serverpublickey >> /home/$user/.ssh/authorized_keys
echo $serverpublickey >> /home/$user/.ssh/known_hosts
echo "public key for the reverseSSH server has been stored in /home/$user/.ssh/authorized_keys and known_hosts"
echo "     [to be used to authenticate the reverseSSH server when it tries to ssh into this Looma]"
echo

pause

###
###
### NEED TO ADD PUBLIC KEY TO REVERSESSH SERVER'S AUTHORIZED_KEYS  ????
##            need to generate the public key first????
echo "enter password 'looma' if asked" # NOTE: could use 'sshpass' here
ssh-copy-id -i /home/$user/.ssh/looma-remote_rsa  looma@54.213.10.240
###
###
#
# this is the IP of the Looma ReverseSSH server on AWS
host=54.213.10.240
# using port 22 for SSH
hostport=22
# populate known_hosts file
ssh-keyscan $host >> /home/$user/.ssh/known_hosts

pause

#make sure "autossh" is installed
if [ ! `which autossh` ]
then
  apt install autossh
fi

#make sure "sshpass" is installed
if [ ! `which sshpass` ]
then
  apt install sshpass
fi

# generate a random port number for the Reverse SSH server to access this Looma with
port=$(shuf -i49151-65535 -n1)

# add to systemd config to always run "autossh"
autosshpath=$(which autossh)
echo "[Unit]" > /etc/systemd/system/reversessh-looma.service
echo "Description=Autossh" >> /etc/systemd/system/reversessh-looma.service
echo "Wants=network-online.target" >> /etc/systemd/system/reversessh-looma.service
echo "After=network-online.target" >> /etc/systemd/system/reversessh-looma.service
echo "StartLimitIntervalSec=0" >> /etc/systemd/system/reversessh-looma.service
echo "" >> /etc/systemd/system/reversessh-looma.service
echo "[Service]" >> /etc/systemd/system/reversessh-looma.service
echo "ExecStart=$autosshpath -M 0 -N -o 'ServerAliveInterval 15' -o 'ServerAliveCountMax 3' -o 'ConnectTimeout 10' -o 'ExitOnForwardFailure yes' -i /home/$user/.ssh/looma-remote_rsa $loomaname@$host -p $hostport -R $port:localhost:22" >> /etc/systemd/system/reversessh-looma.service
echo "Restart=always" >> /etc/systemd/system/reversessh-looma.service
echo "RestartSec=10" >> /etc/systemd/system/reversessh-looma.service
echo "" >> /etc/systemd/system/reversessh-looma.service
echo "[Install]" >> /etc/systemd/system/reversessh-looma.service
echo "WantedBy=multi-user.target" >> /etc/systemd/system/reversessh-looma.service

#  restart systemd
systemctl daemon-reload
systemctl start reversessh-looma
systemctl enable reversessh-looma

pause

#  other Looma setup stuff
echo "\{'looma name':$loomaname,'school name':$schoolname,'ssh-port':$port\}" > /var/www/html/looma-info.txt
# font size, cursor size, terminal background color ???

# create master looma shell command "looma"
echo "source '/var/www/html/Looma/loomaexec' \$@" > /usr/local/bin/looma
chmod 755 /usr/local/bin/looma

echo
echo "loomaSSHinstall is complete"
echo "looma name is $loomaname, school name is $schoolname, random port to SSH from server is $port"
echo
