#!/bin/bash
if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root."
  exit 1
fi

#!/bin/bash
#
# "loomaSSHinstall" script to be run on a Looma box to use reverse SSH server
#     based on the autogenerated install script from "reversessh -a <clientname>" by Termilus
#

pause () {
    echo $1
   read -p "Paused, press [Enter] to continue"
}  #  end pause()

user=odroid

loomaname="garage"
echo "This script will set up this Looma with the name $loomaname"
echo "Note: hostnames are usually 'Lxxx' or 'Nxxx'. hostname must be unique among all Loomas"
echo "the name must be 7 characters or less"
#read loomaname

echo
echo "(Optional) Enter the school name [or Return]:"
read schoolname

touch  /home/$user/.ssh
chmod 700 /home/$user/.ssh
chown $user:$user /home/$user/.ssh

touch /home/$user/.ssh/authorized_keys
chmod 600 /home/$user/.ssh/authorized_keys
chown $user:$user /home/$user/.ssh/authorized_keys

touch /home/$user/.ssh/known_hosts
chmod 600 /home/$user/.ssh/known_hosts
chown $user:$user /home/$user/.ssh/known_hosts

echo "set up .ssh folder";pause

#
# this is the private key for this looma \"$loomaname\" to access the ReverseSSH server
# it gets added to /home/$user/.ssh/ as $loomaname-reversessh_rsa

echo "-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----" > /home/$user/.ssh/$loomaname-reversessh_rsa
chmod 600 /home/$user/.ssh/$loomaname-reversessh_rsa
echo "added private key to /home/$user/.ssh with name $loomaname-reversessh_rsa"
echo
pause

echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDALmAEhI871rXBnWynmQH3f+YXwH4iXXJG3bFjs78aMTpGU8wyKuvhrSK2JLLJkRyKkP7F3YCbsJoYNZAfTWCig1rO4ruK4p9OUeF0ZI7sm2gwu2t6kR2GMPRFFMNPxqBfMGmuFKjoEWysvkGagulFuT0k9AflIg22XtsEiq5ExxldTmt1SlFhyr0CxkzZuySgvd5PlRqJi+uWYgQVAuAA1OGVuiETzxUdDj/wEV++qpzAA1N7YjdG34N43bEPneXN5njK+YazyEI81n1CG52HXpfr3cVvQ8gydUIQl/GsmR9hYQy92eLwMjtggRBiz3SSY6yigLn0wnQZG9g/watQvBHP+86Hla6j2leqBCPjvhUHtNdnHG7YXrV0F9IIrMB3qPlezfHWQSr4oUiC8d6BKxJKJ4W721B9fq1r7g+iya/rV39f5yb5+8cJQXyVDcUceIjG19vU8835zQJwYwN3hj2Mev0Vg+SQRjdH91bqG2znAM6XNJ/+TfDpqAKppD95wwTAS1ku8ge3E9xozru2BwOGgZI3BI3q+YVxsZYNgcQiSbeSl7SKjf2xLm7fBjiXmKNcfF5AlL0FsbZg748+PXaeEQmpNeGvLQ/sg3ulhwWOJ6IMPCr7KYNEgN17ya7845CiRdGEhzn1aKG8l7SX9IpAomL1+eEG8ES7gAMy7w== root@ip-172-31-17-231.us-west-2.compute.internal" >> /home/$user/.ssh/authorized_keys
echo "added public key to Looma Reverse SSH Server to /home/$user/.ssh/authorized_keys"
echo
pause

SSHserver="54.213.10.240"
SSHserverport=22
ssh-keyscan -H $SSHserver >> /home/$user/.ssh/known_hosts
echo "added public key of Looma Reverse SSH Server to /home/$user/.ssh/known_hosts"
echo
pause

#make sure "autossh" is installed
if [ ! `which autossh` ]
then
  apt install autossh
fi

#make sure "sshpass" is installed
if [ ! `which sshpass` ]
then
  apt install sshpass
fi

port=$(shuf -i49151-65535 -n1)
autosshpath=`which autossh`

echo "[Unit]" > /etc/systemd/system/reversessh-$loomaname.service
echo "Description=Autossh" >> /etc/systemd/system/reversessh-$loomaname.service
echo "Wants=network-online.target" >> /etc/systemd/system/reversessh-$loomaname.service
echo "After=network-online.target" >> /etc/systemd/system/reversessh-$loomaname.service
echo "StartLimitIntervalSec=0" >> /etc/systemd/system/reversessh-$loomaname.service
echo "" >> /etc/systemd/system/reversessh-$loomaname.service
echo "[Service]" >> /etc/systemd/system/reversessh-$loomaname.service
echo "ExecStart=$autosshpath -M 0 -N -o 'ServerAliveInterval 15' -o 'ServerAliveCountMax 3' -o 'ConnectTimeout 10' -o 'ExitOnForwardFailure yes' -i /home/$user/.ssh/$loomaname-reversessh_rsa $loomaname@$SSHserver -p $SSHserverport -R $port:localhost:22" >> /etc/systemd/system/reversessh-$loomaname.service

### should be '$loomaname@$SSHserver' or 'looma@$SSHserver' ?????


echo "Restart=always" >> /etc/systemd/system/reversessh-$loomaname.service
echo "RestartSec=10" >> /etc/systemd/system/reversessh-$loomaname.service
echo "" >> /etc/systemd/system/reversessh-$loomaname.service
echo "[Install]" >> /etc/systemd/system/reversessh-$loomaname.service
echo "WantedBy=multi-user.target" >> /etc/systemd/system/reversessh-$loomaname.service

echo "set systemd autossh entry"
pause

systemctl daemon-reload
systemctl start reversessh-$loomaname
systemctl enable reversessh-$loomaname

#  other Looma setup stuff
echo "\{'looma name':$loomaname,'school name':$schoolname,'ssh-port':$port\}" > /var/www/html/looma-info.txt

# create master looma shell command "looma"
echo "source '/var/www/html/Looma/loomaexec' \$@" > /usr/local/bin/looma
chmod 755 /usr/local/bin/looma

echo
echo "Installing reverse SSH on $loomaname is complete"
echo "looma name is $loomaname, school name is $schoolname, random port to SSH from server is $port"
echo
